workflow ctat_rnaseq_mutation {
    call align
    call cosmic_annotate
    call remove_unmapped
    call filter_vcf_cancer
    call index_aligned_bam
    call cravat_annotate_get
    call cravat_annotate_add
    call gatk_add_rg
    call cravat_unzip_response
    call cravate_annotate
    call mark_duplicates
    call cravate_move_response
    call cravate_filter
    call gatk_split_cigar_reads
    call groom_cravat_noncoding_results
    call groom_cravat_coding_results
    call groom_cravate_vcf
    call gatk_realigner_target_creator
    call gatk_variants_table
    call gatk_indel_realigner
    call gatk_base_recalibrator
    call gatk_recalibrated_bam
    call gatk_haplotype_caller
    call make_mutation_json
    call gatk_initial_filtering
    call groom_vcf
    call subset_to_snps
    call edit_rna_editing
    call compress_rnaedit_filtered_vcf
    call dbsnp_annotate
    call snpeff
    call update_snpeff_annotations
}

task align {
    File align_index
    File align_left_sample
    File align_right_sample
    File align_misc_dir
    command {
        STAR --genomeDir ${align_index} \
             --runThreadN 8 \
             --readFilesIn ${align_left_sample} \
                           ${align_right_sample} \
             --outSAMtype BAM SortedByCoordinate \
             --twopassMode Basic \
             --limitBAMsortRAM 30000000000 \
             --outFileNamePrefix ${align_misc_dir}
    }
    output {
        File aligned_bam = ${align_misc_dir}Aligned.out.bam
    }
}
task align {
    command {
        STAR --genomeDir /seq/regev_genome_portal/RESOURCES/human/Hg19/Hg19.fa_star_index \
             --runThreadN 8 \
             --readFilesIn /seq/regev_genome_portal/KCO_TESTING/mutations/FLI1.left.fq \
                           /seq/regev_genome_portal/KCO_TESTING/mutations/FLI1.right.fq \
             --outSAMtype BAM SortedByCoordinate \
             --twopassMode Basic \
             --limitBAMsortRAM 30000000000 \
             --outFileNamePrefix /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/
    }
    output { }
}

task cosmic_annotate {
    File to_annotate_vcf
    File cosmic_vcf

    command {
        /seq/regev_genome_portal/SOFTWARE/bcftools/bin/bcftools annotate --output-type z \
            --annotations ${cosmic_vcf} \
            --columns INFO/COSMIC_ID,INFO/TISSUE,INFO/TUMOR,INFO/FATHMM,INFO/SOMATIC \
            --output${cosmic_annotated} ${to_annotate_vcf}
    }
    output {
        File cosmic_annotated = 
    }
}
task cosmic_annotate {
    command {
        bcftools annotate --output-type z \
            --annotations /seq/regev_genome_portal/RESOURCES/human/Hg19/Annotations/cosmic_v72_grch37/CosmicCodingMuts_v72_grch37_updated_chr.vcf.gz \
            --columns INFO/COSMIC_ID,INFO/TISSUE,INFO/TUMOR,INFO/FATHMM,INFO/SOMATIC \
            --output /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_annotated.vcf.gz /ahg/regev/users/ttickle/dev/ctat_snp/run/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp.vcf_snpeff_updated.vcf.gz
    }
    output {}
}

task remove_unmapped {
    command {
        /seq/regev_genome_portal/SOFTWARE/SAMTOOLS/samtools-1.3/samtools view -hbF 12 \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/Aligned.sortedByCoord.out.bam > \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/Aligned.sortedByCoord.out_maponly.bam
    }
    output {}
}
task remove_unmapped {
    command {
        samtools view -hbF 12 \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/Aligned.sortedByCoord.out.bam > \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/Aligned.sortedByCoord.out_maponly.bam
    }
    output {}
}

task filter_vcf_cancer {
    command {
        filter_vcf_for_cancer.py /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_annotated.vcf.gz \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp_cosmic_filtered.vcf
    }
    output {}
}
task filter_vcf_cancer {
    command {
        filter_vcf_for_cancer.py /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_annotated.vcf.gz \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp_cosmic_filtered.vcf
    }
    output {}
}

task index_aligned_bam {
    command {
        /seq/regev_genome_portal/SOFTWARE/SAMTOOLS/samtools-1.3/samtools index \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/Aligned.sortedByCoord.out_maponly.bam
    }
    output {}
}
task index_aligned_bam {
    command {
        samtools index \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/Aligned.sortedByCoord.out_maponly.bam
    }
    output {}
}

task cravat_annotate_get {
    command {
        annotate_with_cravat.py --classifier Blood-Lymphocyte \
            --email ttickle@broadinstitute.org \
            --max_attempts 180 \
            --wait 60 \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp_cosmic_filtered.vcf \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp_cosmic_filtered_cravat_annotations.gz
    }
    output {}
}

task cravat_annotate_add {
    command {
        /seq/regev_genome_portal/SOFTWARE/bcftools/bin/bcftools annotate \
            --annotations /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/Variant_result_updated.tsv.gz \
            -h /seq/regev_genome_portal/kcoprod/galaxy/tools/Trinity_CTAT/mutation/headers/cravat_annotation.txt \
            --columns "CHROM,POS,CHASM_PVALUE,CHASM_FDR,VEST_PVALUE,VEST_FDR" \
            --output-type z \
            --output /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp_cosmic_filtered_cravate_annotated_coding.vcf.gz \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp_cosmic_filtered.vcf
    }
    output {}
}
task cravat_annotate_add {
    command {
        bcftools annotate \
            --annotations /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/Variant_result_updated.tsv.gz \
            -h /seq/regev_genome_portal/kcoprod/galaxy/tools/Trinity_CTAT/mutation/headers/cravat_annotation.txt \
            --columns "CHROM,POS,CHASM_PVALUE,CHASM_FDR,VEST_PVALUE,VEST_FDR" \
            --output-type z \
            --output /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp_cosmic_filtered_cravate_annotated_coding.vcf.gz \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp_cosmic_filtered.vcf
    }
    output {}
}

task gatk_add_rg {
    command {
        java -jar /seq/regev_genome_portal/SOFTWARE/Picard/picard-tools-1.118/AddOrReplaceReadGroups.jar \
            I=/ahg/regev/users/ttickle/dev/ctat_snp/run/misc/Aligned.sortedByCoord.out_maponly.bam \
            O=/ahg/regev/users/ttickle/dev/ctat_snp/run/misc/sorted.bam \
            SO=coordinate \
            RGID=id \
            RGLB=library \
            RGPL=ILLUMINA \
            RGPU=machine RGSM=FLI1_left
    }
    output {}
}
task gatk_add_rg {
    command {
        java -jar AddOrReplaceReadGroups.jar \
            I=/ahg/regev/users/ttickle/dev/ctat_snp/run/misc/Aligned.sortedByCoord.out_maponly.bam \
            O=/ahg/regev/users/ttickle/dev/ctat_snp/run/misc/sorted.bam \
            SO=coordinate \
            RGID=id \
            RGLB=library \
            RGPL=ILLUMINA \
            RGPU=machine RGSM=FLI1_left
    }
    output {}
}

task cravat_unzip_response {
    command {
        unzip -d /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp.vcf_snpeff_updated_cosmic_filtered_cravat_annotations \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp_cosmic_filtered_cravat_annotations.gz.zip
    }
    output {}
}
task cravat_unzip_response {
    File to_zip
    command {
        unzip -d ${to_zip} ${zipped}
    }
    output {
        File zipped
    }
}

task cravate_annotate {
    command {
        /seq/regev_genome_portal/SOFTWARE/bcftools/bin/bcftools annotate \
            --annotations /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/Variant_non_coding_result_updated.tsv.gz \
            -h /seq/regev_genome_portal/kcoprod/galaxy/tools/Trinity_CTAT/mutation/headers/cravat_annotation.txt \
            --columns "CHROM,POS,CHASM_PVALUE,CHASM_FDR,VEST_PVALUE,VEST_FDR" \
            --output-type z \
            --output /ahg/regev/users/ttickle/dev/ctat_snp/run/annotated_min_filtered.vcf.gz \
                     /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp_cosmic_filtered_cravate_annotated_coding.vcf.gz
    }
    output {}
}
task cravate_annotate {
    File in_vcf
    File cravat_annotation_file
    File cravat_header
    command {
        bcftools annotate \
            --annotations ${cravat_annotation_file} \
            -h ${cravat_header} \
            --columns "CHROM,POS,CHASM_PVALUE,CHASM_FDR,VEST_PVALUE,VEST_FDR" \
            --output-type z \
            --output ${annotated_file} \
            ${in_vcf}
    }
    output {
        File annotated_file
    }
}

task mark_duplicates {
    command {
        java -jar /seq/regev_genome_portal/SOFTWARE/Picard/picard-tools-1.118/MarkDuplicates.jar \
            I=/ahg/regev/users/ttickle/dev/ctat_snp/run/misc/sorted.bam \
            O=/ahg/regev/users/ttickle/dev/ctat_snp/run/misc/dedupped.bam \
            CREATE_INDEX=true \
            M=/ahg/regev/users/ttickle/dev/ctat_snp/run/misc/mark_duplicates_qc_metrics.txt
    }
    output {}
}
task mark_duplicates {
    File in_bam
    command {
        java -jar MarkDuplicates.jar \
            I=${in_bam} \
            O=${out_bam} \
            CREATE_INDEX=true \
            M=${qc_metrics}
    }
    output {
        File out_bam
        File qc_metrics
    }
}

task cravate_move_response {
    command {
        cp {/ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp.vcf_snpeff_updated_cosmic_filtered_cravat_annotations/*/Variant.Result.tsv,/ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp.vcf_snpeff_updated_cosmic_filtered_cravat_annotations/*/Variant_Non-coding.Result.tsv} \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp.vcf_snpeff_updated_cosmic_filtered_cravat_annotations
    }
    output {}
}
task cravate_move_response {
    File move_coding
    File move_non_coding
    command {
        cp {${move_coding},${move_non_coding}} ${location}
    }
    output {
        File location
    }
}

task cravate_filter {
    command {
        /seq/regev_genome_portal/SOFTWARE/bcftools/bin/bcftools filter \
            --include "CHASM_PVALUE < 0.3 || VEST_PVALUE < 0.3" \
            --output-type v \
            --output /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp_cosmic_filtered_cravate_annotated_filtered.vcf \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/annotated_min_filtered.vcf.gz
    }
    output {}
}
task cravate_filter {
    File in_vcf
    command {
        bcftools filter \
            --include "CHASM_PVALUE < 0.3 || VEST_PVALUE < 0.3" \
            --output-type v \
            --output ${out_vcf} ${in_vcf}
    }
    output {
        File out_vcf
    }
}

task gatk_split_cigar_reads {
    command {
        java -jar /humgen/gsa-hpprojects/GATK/bin/GenomeAnalysisTK-3.1-1-g07a4bf8/GenomeAnalysisTK.jar \
            -T SplitNCigarReads \
            -R /seq/regev_genome_portal/RESOURCES/human/Hg19/Hg19.fa \
            -I /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/dedupped.bam \
            -o /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/split.bam \
            -rf ReassignOneMappingQuality \
            -RMQF 255 \
            -RMQT 60 \
            -U ALLOW_N_CIGAR_READS
    }
    output {}
}
task gatk_split_cigar_reads {
    File reference
    File in_bam
    command {
        java -jar GenomeAnalysisTK.jar \
            -T SplitNCigarReads \
            -R ${reference} \
            -I ${in_bam} \
            -o ${out_bam} \
            -rf ReassignOneMappingQuality \
            -RMQF 255 \
            -RMQT 60 \
            -U ALLOW_N_CIGAR_READS
    }
    output {
        File out_bam
    }
}

task groom_cravat_noncoding_results {
    comand {
        groom_cravat_annotation.py /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp.vcf_snpeff_updated_cosmic_filtered_cravat_annotations/Variant_Non-coding.Result.tsv \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/Variant_non_coding_result_updated.tsv
    }
    output {}
}
task groom_cravat_noncoding_results {
    File in_tab
    comand {
        groom_cravat_annotation.py ${in_tab} ${out_tab}
    }
    output {
        File out_tab
    }
}

task groom_cravat_coding_results {
    command {
        groom_cravat_annotation.py /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp.vcf_snpeff_updated_cosmic_filtered_cravat_annotations/Variant.Result.tsv \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/Variant_result_updated.tsv
    }
    output {}
}
task groom_cravat_coding_results {
    File in_tab
    command {
        groom_cravat_annotation.py ${in_tab} ${out_tab}
    }
    output {
        File out_tab
    }
}

task groom_cravate_vcf {
    command {
        groom_vcf.py /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp_cosmic_filtered_cravate_annotated_filtered.vcf \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/cancer.vcf
    }
    output {}
}
task groom_cravate_vcf {
    File in_vcf
    command {
        groom_vcf.py ${in_vcf} ${out_vcf}
    }
    output {
        File out_vcf
    }
}

task gatk_realigner_target_creator {
    command {
        java -Xmx2g -jar /humgen/gsa-hpprojects/GATK/bin/GenomeAnalysisTK-3.1-1-g07a4bf8/GenomeAnalysisTK.jar \
            -T RealignerTargetCreator \
            -R /seq/regev_genome_portal/RESOURCES/human/Hg19/Hg19.fa \
            -I /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/split.bam \
            --out /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/forIndelRealigner.intervals \
            --known /seq/regev_genome_portal/RESOURCES/human/Hg19/dbsnp_138.b37_Hg19.vcf
    }
    output {}
}
task gatk_realigner_target_creator {
    File reference
    File in_bam
    File known_sites_db
    command {
        java -Xmx2g -jar GenomeAnalysisTK.jar \
            -T RealignerTargetCreator \
            -R ${reference} \
            -I ${in_bam} \
            --out ${intervales} \
            --known ${known_sites_db}
    }
    output {
        File intervals =
    }
}

task gatk_variants_table {
    command {
        java -jar /humgen/gsa-hpprojects/GATK/bin/GenomeAnalysisTK-3.1-1-g07a4bf8/GenomeAnalysisTK.jar \
            -R /seq/regev_genome_portal/RESOURCES/human/Hg19/Hg19.fa \
            -T VariantsToTable \
            -V /ahg/regev/users/ttickle/dev/ctat_snp/run/cancer.vcf \
            -F CHROM -F POS -F REF -F ALT -F GENE -F DP -F QUAL -F MQ -F SAO \
            -F NSF -F NSM -F NSN -F TUMOR -F TISSUE -F COSMIC_ID -F KGPROD -F RS \
            -F PMC -F CRAVAT_PVALUE -F CRAVAT_FDR -F VEST_PVALUE -F VEST_FDR \
            --allowMissingData \
            --unsafe LENIENT_VCF_PROCESSING \
            -o /ahg/regev/users/ttickle/dev/ctat_snp/run/cancer.tab
    }
    output {}
}
task gatk_variants_table {
    File reference
    File in_vcf
    command {
        java -jar GenomeAnalysisTK.jar \
            -R ${reference} \
            -T VariantsToTable \
            -V ${in_vcf} \
            -F CHROM -F POS -F REF -F ALT -F GENE -F DP -F QUAL -F MQ -F SAO \
            -F NSF -F NSM -F NSN -F TUMOR -F TISSUE -F COSMIC_ID -F KGPROD -F RS \
            -F PMC -F CRAVAT_PVALUE -F CRAVAT_FDR -F VEST_PVALUE -F VEST_FDR \
            --allowMissingData \
            --unsafe LENIENT_VCF_PROCESSING \
            -o ${out_table}
    }
    output {
        File out_tab =
    }
}

task gatk_indel_realigner {
    command {
        java -Xmx4g -jar /humgen/gsa-hpprojects/GATK/bin/GenomeAnalysisTK-3.1-1-g07a4bf8/GenomeAnalysisTK.jar \
            -T IndelRealigner \
            -R /seq/regev_genome_portal/RESOURCES/human/Hg19/Hg19.fa \
            -I /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/split.bam \
            -targetIntervals /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/forIndelRealigner.intervals \
            --out /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/realigned.bam \
            -known /seq/regev_genome_portal/RESOURCES/human/Hg19/dbsnp_138.b37_Hg19.vcf
    }
    output {}
}
task gatk_indel_realigner {
    File reference
    File in_bam
    File intervals
    File known_sites_db
    command {
        java -Xmx4g -jar GenomeAnalysisTK.jar \
            -T IndelRealigner \
            -R ${reference} \
            -I ${in_bam} \
            -targetIntervals ${intervals} \
            --out ${out_bam} \
            -known ${known_sites_db}
    }
    output {
        File out_bam =
    }
}

task gatk_base_recalibrator {
    command {
        java -Xmx4g -jar /humgen/gsa-hpprojects/GATK/bin/GenomeAnalysisTK-3.1-1-g07a4bf8/GenomeAnalysisTK.jar \
            -T BaseRecalibrator \
            -I /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/realigned.bam \
            -R /seq/regev_genome_portal/RESOURCES/human/Hg19/Hg19.fa \
            --out /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/recal_table.table \
            -knownSites /seq/regev_genome_portal/RESOURCES/human/Hg19/dbsnp_138.b37_Hg19.vcf
    }
    output {}
}
task gatk_base_recalibrator {
    File realigned_bam
    File reference
    File known_sites_db
    command {
        java -Xmx4g -jar GenomeAnalysisTK.jar \
            -T BaseRecalibrator \
            -I ${realigned_bam} \
            -R ${reference} \
            --out ${out_table} \
            -knownSites ${known_sites_db}
    }
    output {
        File out_table =
    }
}

task gatk_recalibrated_bam {
    File reference
    File in_bam
    File recalibration_table
    command {
        java -Xmx2g -jar GenomeAnalysisTK.jar \
            -R ${reference} \
            -T PrintReads \
            --out ${out_bam} \
            -I ${in_bam} \
            --BQSR ${recalibration_table}
    }
    output {
        File out_bam =
    }
}
task gatk_recalibrated_bam {
    File reference
    File realigned_bam
    File recalibration_table
    command {
        java -Xmx2g -jar GenomeAnalysisTK.jar \
            -R ${reference} \
            -T PrintReads \
            --out ${out_bam} \
            -I ${realigned_bam} \
            --BQSR ${recalibration_table}
    }
    output {
        File out_bam = 
    }
}

task gatk_haplotype_caller {
    command {
        java -jar /humgen/gsa-hpprojects/GATK/bin/GenomeAnalysisTK-3.1-1-g07a4bf8/GenomeAnalysisTK.jar \
            -T HaplotypeCaller \
            -R /seq/regev_genome_portal/RESOURCES/human/Hg19/Hg19.fa \
            -I /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/recalibrated.bam \
            -recoverDanglingHeads \
            -dontUseSoftClippedBases \
            -stand_call_conf 20.0 \
            -stand_emit_conf 20.0 \
            --out /ahg/regev/users/ttickle/dev/ctat_snp/run/variants.vcf
    }
    output {}
}
task gatk_haplotype_caller {
    File reference
    File bam
    command {
        java -jar GenomeAnalysisTK.jar \
            -T HaplotypeCaller \
            -R ${reference} \
            -I ${bam} \
            -recoverDanglingHeads \
            -dontUseSoftClippedBases \
            -stand_call_conf 20.0 \
            -stand_emit_conf 20.0 \
            --out ${called_vcf}
    }
    output {
        File called_vcf =
    }
}

task make_mutation_json {
    command {
        make_mutation_inspector_json.py \
            --sample /ahg/regev/users/ttickle/dev/ctat_snp/run \
            --tab /ahg/regev/users/ttickle/dev/ctat_snp/run/cancer.tab \
            --bam /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/recalibrated.bam \
            --bam_index /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/recalibrated.bai \
            --bed /seq/regev_genome_portal/RESOURCES/human/Hg19/hg19.refGene.sort.bed \
            --bed_index /seq/regev_genome_portal/RESOURCES/human/Hg19/hg19.refGene.sort.bed.idx \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/mutation_inspector.json
    }
    output {}
}
task make_mutation_json {
    File cancer_bam
    File cancer_bai
    File cancer_bed
    File cancer_dir
    File cancer_idx
    File cancer_tab
    command {
        make_mutation_inspector_json.py \
            --sample ${cancer_dir} \
            --tab ${cancer_tab} \
            --bam ${cancer_bam} \
            --bam_index ${cancer_bai} \
            --bed ${cancer_bed} \
            --bed_index ${cancer_idx} \
            ${out_json}
    }
    output {
        File out_json =
    }
}

task gatk_initial_filtering {
    command {
        java -jar /humgen/gsa-hpprojects/GATK/bin/GenomeAnalysisTK-3.1-1-g07a4bf8/GenomeAnalysisTK.jar \
            -T VariantFiltration \
            -R /seq/regev_genome_portal/RESOURCES/human/Hg19/Hg19.fa \
            -V /ahg/regev/users/ttickle/dev/ctat_snp/run/variants.vcf \
            -window 35 \
            -cluster 3 \
            -filterName FS \
            -filter "FS > 30.0" \
            -filterName QD \
            -filter "QD < 2.0" \
            --out /ahg/regev/users/ttickle/dev/ctat_snp/run/variants_initial_filtering.vcf
    }
    output {}
}
task gatk_initial_filtering {
    File reference
    File to_update_vcf
    command {
        java -jar GenomeAnalysisTK.jar \
            -T VariantFiltration \
            -R ${reference} \
            -V ${to_update_vcf} \
            -window 35 \
            -cluster 3 \
            -filterName FS \
            -filter "FS > 30.0" \
            -filterName QD \
            -filter "QD < 2.0" \
            --out ${updated_vcf}
    }
    output {
        File updated_vcf =
    }
}

task groom_vcf {
    command {
        groom_vcf.py /ahg/regev/users/ttickle/dev/ctat_snp/run/variants_initial_filtering.vcf
            /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean.vcf
    }
    output {}
}
task groom_vcf {
    File to_update_vcf
    command {
        groom_vcf.py ${to_update_vcf} ${updated_vcf}
    }
    output {
        File updated_vcf =
    }
}

task subset_to_snps {
    command {
        reduce_vcf_to_snps.py /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean.vcf \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp.vcf
    }
    output {}
}
task subset_to_snps {
    File to_update_vcf
    command {
        reduce_vcf_to_snps.py ${to_update_vcf} ${updated_vcf}
    }
    output {
        File updated_vcf =
    }
}

task edit_rna_editing {
    command {
        filter_snps_rna_editing.py \
            --darned /seq/regev_genome_portal/RESOURCES/human/Hg19/Annotations/darned_hg19.txt \
            --radar /seq/regev_genome_portal/RESOURCES/human/Hg19/Annotations/radar_hg19_v2.txt \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp.vcf \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp_RNAedit.vcf
    }
    output {}
}
task edit_rna_editing {
    File darned_db
    File radar_db
    File to_update_vcf
    command {
        filter_snps_rna_editing.py \
            --darned ${darned_db} \
            --radar ${radar_db} \
            ${to_update_vcf} \
            ${updated_vcf}
    }
    output {
        File updated_vcf =
    }
}

task compress_rnaedit_filtered_vcf {
    command {
        /home/unix/bhaas/utilities/bgzip \
            -c /ahg/regev/users/ttickle/dev/ctat_snp/run/misc/variants_initial_filtering_clean_snp_RNAedit.vcf > /ahg/regev/users/ttickle/dev/ctat_snp/run/variants_initial_filtering_clean_snp_RNAedit.vcf.gz
    }
    output {}
}
task compress_rnaedit_filtered_vcf {
    File to_compress_vcf
    command {
        bgzip -c ${to_compress_vcf} > ${compressed_vcf}
    }
    output {
        File compressed_vcf =
    }
}

task dbsnp_annotate {
    command {
        /seq/regev_genome_portal/SOFTWARE/bcftools/bin/bcftools annotate \
            --output-type z \
            --annotations /seq/regev_genome_portal/RESOURCES/human/Hg19/dbsnp_138.b37_Hg19.vcf.gz \
            --columns INFO/COMMON,INFO/PM,INFO/NSF,INFO/NSM,INFO/NSN,INFO/SAO,INFO/KGPROD,INFO/KGValidated,INFO/MUT,INFO/WTD,INFO/VLD,INFO/RS,INFO/PMC \
            --output /ahg/regev/users/ttickle/dev/ctat_snp/run/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp.vcf.gz \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/variants_initial_filtering_clean_snp_RNAedit.vcf.gz
    }
    output {}
}
task dbsnp_annotate {
    File dbsnp_vcf
    File to_update_vcf
    command {
        bcftools annotate \
            --output-type z \
            --annotations ${dbsnp_vcf} \
            --columns INFO/COMMON,INFO/PM,INFO/NSF,INFO/NSM,INFO/NSN,INFO/SAO,INFO/KGPROD,INFO/KGValidated,INFO/MUT,INFO/WTD,INFO/VLD,INFO/RS,INFO/PMC \
            --output ${updated_vcf} \
            ${to_update_vcf}
    }
    output {
        File updated_vcf = 
    }
}

task snpeff {
    command {
        /home/unix/bhaas/utilities/bgzip \
            -cd /ahg/regev/users/ttickle/dev/ctat_snp/run/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp.vcf.gz \
            | java -jar /seq/regev_genome_portal/SOFTWARE/snpEff/snpEff.jar \
                -nostats \
                -noLof \
                -no-downstream \
                -no-upstream hg19 > /ahg/regev/users/ttickle/dev/ctat_snp/run/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp.vcf_snpeff.vcf
    }
    output {}
}
task snpeff {
    File to_update_vcf
    command {
        bgzip -cd ${to_update_vcf} \
            | java -jar snpEff.jar \
                -nostats \
                -noLof \
                -no-downstream \
                -no-upstream hg19 > ${updated_vcf}
    }
    output {
        File updated_vcf =
    }
}

task update_snpeff_annotations {
    command {
        update_snpeff_annotations.py /ahg/regev/users/ttickle/dev/ctat_snp/run/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp.vcf_snpeff.vcf \
            /ahg/regev/users/ttickle/dev/ctat_snp/run/variants_initial_filtering_clean_snp_RNAedit.vcf_dbsnp.vcf_snpeff_updated.vcf
    }
    output {}
}
task update_snpeff_annotations {
    File to_update_vcf
    command {
        update_snpeff_annotations.py ${to_update_vcf} ${updated_vcf}
    }
    output {
        File updated_vcf =
    }
}

#task {
#    command {
#        cp /seq/regev_genome_portal/RESOURCES/human/Hg19/hg19.refGene.sort.bed /ahg/regev/users/ttickle/dev/ctat_snp/run/hg19.refGene.sort.bed
#    }
#    output {}
#}
